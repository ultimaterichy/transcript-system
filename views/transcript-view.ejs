<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <!-- jsPDF library -->
    <script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
    <script src="https://smtpjs.com/v3/smtp.js"></script>
    <script src="/javascripts/html2canvas.js"></script>
    <style>
        body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: #FAFAFA;
            font: 12pt "Tahoma";
        }
        * {
            box-sizing: border-box;
            -moz-box-sizing: border-box;
        }
        .page {
            width: 210mm;
            min-height: 297mm;
            padding: 20mm;
            margin: 10mm auto;
            border: 1px #D3D3D3 solid;
            border-radius: 5px;
            background: white;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
        }
        .subpage {
            padding: 1cm;
            border: 5px red solid;
            height: 257mm;
            outline: 2cm #FFEAEA solid;
        }
        
        @page {
            size: A4;
            margin: 0;
        }
        @media print {
            html, body {
                width: 210mm;
                height: 297mm;        
            }
            .page {
                margin: 0;
                border: initial;
                border-radius: initial;
                width: 210mm;
                min-height: 297mm;
                box-shadow: initial;
                background: initial;
                page-break-after: always;
            }
        }
    </style>

    <title>Transcript System</title>
  </head>
  <body>
   <!-- Nav As a heading -->
    <nav class="navbar navbar-dark" style="background-color: #5400FF; color: white;">
        <span class="navbar-brand mb-0 h1">Transcript System</span>
    </nav>


    <!-- Main body -->


    <div class="container">
        <div class="d-flex justify-content-center mt-4 py-4">
            <div class="">
                <div class="text-center mb-4">
                    <button class="btn btn-success float-right mb-4" style="background-color: #5400FF;" onclick="generate()" id="forward">Forward</button>
                </div>
                <div class="mt-5 alert alert-info">
                    NOTE: Only part of the transcript is shown here. On forwarding, the complete transcript will be sent to the institution whose address was provided
                </div>
                <input type="text" style="display: none;" id="receiver" value="<%= transcripts.receiver %>">
                <input type="text" style="display: none;" id="email" value="<%= transcripts.user.email %>" />
                <input type="text" style="display: none;" id="phone" value="<%= transcripts.phone %>" />
                <% if (error != null) { %>
                    <div class="alert alert-danger"><%= error %> </div>
                <% } else if(success != null) { %>
                    <div class="alert alert-success"><%= success %> </div>
                <% } %>
                
                <% let groupedResult = new Map() %> 
                <% for (let j = 0; j < transcripts.data.length; j++) {
                    if(groupedResult.has(transcripts.data[j].session)){
                        groupedResult.get(transcripts.data[j].session).push(transcripts.data[j]);
                    } else{
                        groupedResult.set(transcripts.data[j].session, new Array());
                        groupedResult.get(transcripts.data[j].session).push(transcripts.data[j]);
                    }
                } %> 

                <!-- main transcript content -->
                <div class="border border-dark p-4 mt-5 page" id="content">
                    <!-- information section -->
                    <div>
                        
                        <!-- header -->
                        <div>
                            <h5 class="text-center text-success small"><span class="mr-2">NASARAWA</span> STATE UNIVERSITY KEFFI</h5>
                            <div class="text-center text-success small">(OFFICE OF THE REGISTERER)</div>
                        </div>
                        <!-- image -->
                        <div class="d-flex flex-row justify-content-between" style="margin-top: -20px;">
                            <p class="align-self-center" style="text-decoration: underline;">CONFIDENTIAL</p>
                            <img src="/images/nsuk.png" alt="" width="78">
                        </div>
                        <div class="text-center font-weight-bold" style="text-decoration: underline;">ACADEMIC TRANSCRIPT</div>
                        <!-- other details -->
                        <div class="small">
                            <div class="my-3">
                                <div class="d-flex flex-row">
                                    <span>Name(Surname, lastname) </span><span class="flex-grow-1 border-bottom border-dark pl-3"><%= transcripts.user.name %> </span>
                                </div>
                                <div class="d-flex flex-row">
                                    <div class="flex-grow-1 d-flex flex-row">
                                        <span>Sex(male/female)</span><span class="flex-grow-1 border-bottom border-dark pl-3"> <%= transcripts.user.gender %>   </span>
                                    </div>
                                    <!-- <div class="flex-grow-1 d-flex flex-row">
                                        <span>DOB</span><span class="flex-grow-1 border-bottom border-dark pl-3"><%= transcripts.user.dob %></span>
                                    </div> -->
                                </div>
                                <div class="d-flex flex-row">
                                    <div class="flex-grow-1 d-flex flex-row">
                                        <span>Date in this university(Entered)</span><span class="flex-grow-1 border-bottom border-dark pl-3"><%= transcripts.data[0].session %> </span>
                                    </div>
                                    <% if (transcripts.data.length > 0) { 
                                        let spls = transcripts.data[0].session.split('/');
                                        var l = Number(spls[0]) + Number(transcripts.user.duration);
                                        var r = Number(spls[1]) + Number(transcripts.user.duration);
                                    } %> 
                                    <div class="flex-grow-1 d-flex flex-row">
                                        <span>(left)</span><span class="flex-grow-1 border-bottom border-dark pl-3"><%= l + '/' + r %></span>
                                    </div>
                                </div>
                                <div class="d-flex flex-row">
                                    <span>Reasons for leaving </span><span class="flex-grow-1 border-bottom border-dark pl-3">Programme completion</span>
                                </div>
                                <div class="d-flex flex-row">
                                    <div class="flex-grow-1 d-flex flex-row">
                                        <span>Faculty</span><span class="flex-grow-1 border-bottom border-dark pl-3"><%= transcripts.user.faculty %> </span>
                                    </div>
                                    <div class="flex-grow-1 d-flex flex-row">
                                        <span>Department</span><span class="flex-grow-1 border-bottom border-dark pl-3"><%= transcripts.user.department %></span>
                                    </div>
                                </div>
                                <div class="d-flex flex-row">
                                    <span>Course of study/specialization</span><span class="flex-grow-1 border-bottom border-dark pl-3"><%= transcripts.user.department %></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- create table header -->
                    <table class="table table-bordered">
                        <tr align="center">
                            <th>Year of study</th>
                            <th>Course code</th>
                            <th>Course title</th>
                            <th>Grade</th>
                            <th>Units</th>
                            <th>Remark</th>
                        </tr> 
                        <% for(const [k, v] of groupedResult) {%> 
                            <tr align="center">
                                <td><%= k %></td>
                                <% if (v.length > 0) { %>
                                    <td><%= v[0].code %></td>
                                    <td><%= v[0].title %></td>
                                    <td><%= v[0].grade %></td>
                                    <td><%= v[0].unit %></td>
                                    <td><%= v[0].remark %></td>
                                <% } %>
                            </tr>
                            <!-- iterate over values -->
                            <% if (v.length > 1) { %>
                                
                                <% for( let index = 1; index < v.length; index++ ) { %>
                                    <tr align="center">
                                        <td></td>
                                        <td><%= v[index].code %></td>
                                        <td><%= v[index].title %></td>
                                        <td><%= v[index].grade %></td>
                                        <td><%= v[index].unit %></td>
                                        <td><%= v[index].remark %></td>
                                    </tr>
                                <% } %>
                                
                            <% } %>
                        <% } %> 
                    </table>
                </div>
                <div id="elementH"></div>
            </div>
        </div>
    </div>




    <!-- Main body ends -->
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" ></script>
    
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" integrity="sha384-w1Q4orYjBQndcko6MimVbzY0tgp4pWB4lZ7lr30WKz0vr/aWKhXdBNmNb5D92v7s" crossorigin="anonymous"></script>

    <script src="https://js.paystack.co/v1/inline.js"></script>
    <script>
        window.jsPDF = window.jspdf.jsPDF;
        function generate(){
            var doc = new jsPDF();
            
            var doc = new jsPDF('p', 'pt', 'a3');
            window.html2canvas = html2canvas;

            doc.html(document.getElementById('content'), {
                callback: function (doc) {
                    // doc.save();
                    // send to mail
                    let blob = doc.output('datauristring');
                    let frmData = new FormData();
                    // frmData.append('file', blob)
                    sendEmail(blob);
                },
                x: 10,
                y: 10    
            });

        }

        function sendEmail(file) {
            // const paymentForm = document.getElementById('paymentForm');
            // paymentForm.addEventListener("submit", payWithPaystack, false);
            // function payWithPaystack(e) {
            // e.preventDefault();
            let handler = PaystackPop.setup({
                key: 'pk_test_c1c26c51abe5e576ac737ea30f256996356051a8', // Replace with your public key
                email: document.getElementById("email").value,
                amount: 5000 * 100,
                ref: ''+Math.floor((Math.random() * 1000000000) + 1), // generates a pseudo-unique reference. Please replace with a reference you generated. Or remove the line entirely so our API will generate one for you
                // label: "Optional string that replaces customer email"
                onClose: function(){
                    alert('Window closed.');
                },
                callback: function(response){
                    let message = 'Payment complete! Reference: ' + response.reference;
                    alert(message);
                    // send
                    let rec = $('#receiver').val();
                    $.post("/send-transcript",
                    {
                        receiver: rec,
                        file: file,
                        user: document.getElementById('phone').value,
                    },
                    function(data, status){
                        if(data.fail){
                            alert('Failed to forward');
                        } else{
                            alert('Forwarded successfully');
                        }

                    });
                }
            });
            handler.openIframe();
            }
    </script>
    
  </body>
</html>